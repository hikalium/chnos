     1 00000000                                 
     2 00000000                                 
     3 00000000                                 [INSTRSET "i486p"]
     4  = 00000115                              VBEMODE	equ		0x0115	;標準は0x0115
     5 00000000                                 ; （画面モード一覧）
     6 00000000                                 ;0x0100  640x400  256  
     7 00000000                                 ;0x0101  640x480  256  
     8 00000000                                 ;0x0102  800x600  16  *
     9 00000000                                 ;0x0103  800x600  256  
    10 00000000                                 ;0x0104  1024x768  16  *
    11 00000000                                 ;0x0105  1024x768  256  
    12 00000000                                 ;0x0106  1280x1024  16  *
    13 00000000                                 ;0x0107  1280x1024  256  *
    14 00000000                                 ;0x010D  320x200  約32000色(1:5:5:5)  *
    15 00000000                                 ;0x010E  320x200  約65000色(5:6:5)  *
    16 00000000                                 ;0x010F  320x200  約1678万色(8:8:8)  *
    17 00000000                                 ;0x0110  640x480  約32000色(1:5:5:5)  ?
    18 00000000                                 ;0x0111  640x480  約65000色(5:6:5)  
    19 00000000                                 ;0x0112  640x480  約1678万色(8:8:8)  
    20 00000000                                 ;0x0113  800x600  約32000色(1:5:5:5) ? 
    21 00000000                                 ;0x0114  800x600  約65000色(5:6:5)  
    22 00000000                                 ;0x0115  800x600  約1678万色(8:8:8)  
    23 00000000                                 ;0x0116  1024x768  約32000色(1:5:5:5)?  
    24 00000000                                 ;0x0117  1024x768  約65000色(5:6:5)  
    25 00000000                                 ;0x0118  1024x768  約1678万色(8:8:8)  
    26 00000000                                 ;0x0119  1280x1024  約32000色(1:5:5:5)* 
    27 00000000                                 ;0x011A  1280x1024  約65000色(5:6:5) * 
    28 00000000                                 ;0x011B  1280x1024  約1678万色(8:8:8)  *
    29 00000000                                 
    30 00000000                                 
    31  = 00280000                              BOTPAK	equ		0x00280000		;bootpackのロード先
    32  = 00100000                              DSKCAC	equ		0x00100000		;ディスクキャッシュの場所
    33  = 00008000                              DSKCAC0	equ		0x00008000		;ディスクキャッシュの場所（リアルモード）
    34 00000000                                 
    35 00000000                                 ; BOOT_INFO関係
    36  = 00000FF0                              CYLS	equ		0x0ff0			;ブートセクタが設定する
    37  = 00000FF1                              LEDS	equ		0x0ff1			;キーボードの状態を記録
    38  = 00000FF2                              VMODE	equ		0x0ff2			;色数に関する情報。何ビットカラーか？（VESAINFOを使用することを推奨）
    39  = 00000FF4                              SCRNX	equ		0x0ff4			;解像度のX（VESAINFOを使用することを推奨）
    40  = 00000FF6                              SCRNY	equ		0x0ff6			;解像度のY（VESAINFOを使用することを推奨）
    41  = 00000FF8                              VRAM	equ		0x0ff8			;グラフィックバッファの開始番地（VESAINFOを使用することを推奨）
    42 00000000                                 
    43 00000000                                 
    44 00000000                                 [BITS 16]
    45 00000000                                 
    46                                          	org	0xc200				;このプログラムは、0xc200番地から始まる
    47 0000C200                                 asmhead:					
    48 0000C200 B8 0000                         	mov	ax, 0				;レジスタ初期化。axを0に。
    49 0000C203 8E D0                           	mov	ss, ax				;レジスタ初期化。ssをaxに。つまり、ssを0に。
    50 0000C205 BC C200                         	mov	sp, 0xc200			;スタックポインタを初期化。spを0xc200に。
    51 0000C208 8E D8                           	mov	ds, ax				;レジスタ初期化。dsをaxに。つまり、dsを0に。
    52 0000C20A 8E C0                           	mov	es, ax				;レジスタ初期化。esをaxに。つまり、esを0に。
    53 0000C20C                                 
    54 0000C20C E8 0068                         	call	backc				;テキストモード背景の初期化。
    55 0000C20F 66 8D 36 C6F0                   	lea	esi, [msg001]    		;msg001のアドレスをesiに代入する。
    56 0000C214 B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
    57 0000C217 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
    58 0000C219 66 BF 00000000                  	mov	edi, 0			    	;文字の位置指定。ゼロ行目は0。一行目は80*2。
    59 0000C21F E8 0038                         	call	printf				;printfを呼び出す。
    60 0000C222                                 
    61 0000C222 E8 006A                         	call	a20_try_loop			;A20GATEをonにする。失敗すると、戻ってこない。
    62 0000C225 66 8D 36 C70B                   	lea	esi, [msg002]			;msg002のアドレスをesiに代入する。
    63 0000C22A B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
    64 0000C22D 8E C0                           	mov	es, ax				;esに0xB800を入れる。esに直接代入はできないので。
    65 0000C22F 66 BF 000000A0                  	mov	edi, 80*2			;画面の一行目から始める。
    66 0000C235 E8 0022                         	call	printf				;printfを呼び出す。
    67 0000C238                                 
    68 0000C238 E8 0106                         	call	vbecheck			;VesaBiosExtentionで画面モード切替。失敗すると、戻ってこない。
    69 0000C23B E8 037F                         	call	keyled				;BIOSを利用して、キーボードのLEDなどの情報を取得。
    70 0000C23E E8 0384                         	call	pmode				;プロテクテッド・バーチャルアドレスモードに移行。戻ってこない。
    71 0000C241                                 
    72 0000C241                                 
    73 0000C241                                 ;サブルーチン
    74 0000C241                                 
    75 0000C241                                 halthalt:
    76 0000C241 66 8D 36 C750                   	lea	esi, [msg005]			;msg003のアドレスをesiに代入する。
    77 0000C246 B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
    78 0000C249 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
    79 0000C24B 66 BF 00000500                  	mov	edi, 80*2*2*2*2			;画面の四行目から始める。
    80 0000C251 E8 0006                         	call	printf				;printfを呼び出す。
    81 0000C254 E8 0434                         	call	entkeywait			;エンターキーを押すまで戻ってこない。
    82 0000C257 E8 043B                         	call	shutdown			;シャットダウンする。
    83 0000C25A                                 
    84 0000C25A                                 printf:						;テキストモード文字表示ルーチン
    85 0000C25A 66 50                           	push	eax		 		;eaxをスタックに保存。
    86 0000C25C                                 printf_loop:
    87 0000C25C 67 8A 06                        	mov	al, byte [esi]			;esi番地の文字をalに代入。
    88 0000C25F 67 26 88 07                     	mov	byte [es:edi], al		;alを画面の指定した番地に代入。
    89 0000C263 08 C0                           	or	al, al				;alが0なのかを調べる。
    90 0000C265 74 0D                           	jz	printf_end			;0であれば、printf_endにジャンプする。
    91 0000C267 66 47                           	inc	edi				;0でなければ、ediを1つ増やす
    92 0000C269 67 26 C6 07 06                  	mov	byte [es:edi], 0x06		;文字の色と背景色の値を入れる。
    93 0000C26E 66 46                           	inc	esi				;次の文字を取り出すためにesiを1つ増やす。
    94 0000C270 66 47                           	inc	edi				;画面に次の文字を表示するためにediを増やす。
    95 0000C272 EB E8                           	jmp	printf_loop			;printf_loopに行く。これを文字数分繰り返す。
    96 0000C274                                 printf_end:
    97 0000C274 66 58                           	pop	eax				;スタックに保存しておいたeaxをeaxに戻す。
    98 0000C276 C3                              	ret					;呼び出し元に戻る。
    99 0000C277                                 
   100 0000C277                                 backc:						;テキストモード背景色描画ルーチン
   101 0000C277 B8 B800                         	mov	ax,0xb800			;アドレスの指定。テキストモードは、0xB800から始まる。
   102 0000C27A 8E C0                           	mov	es,ax				;esに0xB800を入れる。esに直接代入はできないので。
   103 0000C27C BF 0000                         	mov	di,0				;画面の一番初めから始める。
   104 0000C27F A1 C8DA                         	mov	ax,word[backcc]			;axに書く文字を代入。
   105 0000C282 B9 07FF                         	mov	cx,0x7ff			;0x7ff回繰り返す。
   106 0000C285                                 	
   107 0000C285                                 paint:						;テキストモード背景色描画ルーチンループ
   108 0000C285 26 89 05                        	mov	word[es:di],ax			;画面の番地にaxを代入。
   109 0000C288 83 C7 02                        	add	di,2				;画面の番地を増やす。
   110 0000C28B 49                              	dec	cx				;cxを減らして、回数を数える。
   111 0000C28C 75 F7                           	jnz	paint				;cxがゼロではなかったら、また繰り返す。
   112 0000C28E C3                              	ret					;cxがゼロだったら、呼び出し元に戻る。
   113 0000C28F                                 
   114  = 00000020                              A20_TEST_LOOPS		equ	32 	  	;A20GATEがONになったかテストするループの回数。
   115  = 000000FF                              A20_ENABLE_LOOPS	equ	255 	 	;A20GATEがONになるまでがんばる全体のループの回数。 
   116  = 00000200                              A20_TEST_ADDR		equ	4*0x80		;A20GATEテスト対象のアドレス。
   117 0000C28F                                 
   118 0000C28F                                 
   119 0000C28F                                 a20_try_loop:					;A20GATE有効化ルーチン
   120 0000C28F                                 a20_none:
   121 0000C28F E8 005E                         	call	a20_test			;A20GATEがすでにONになっていないか調べる。
   122 0000C292 75 5B                           	jnz	a20_done			;すでにONだったら必要ないので、終了。
   123 0000C294                                 a20_bios:					;BIOS (INT 0x15, AX=0x2401)を使用したA20GATE有効化を試す。
   124 0000C294 B8 2401                         	mov	ax, 0x2401			;機能番号0x2401=A20をオンにする。
   125 0000C297                                 						;機能番号0x2400=A20をオフにする。
   126 0000C297 66 9C                           	pushfd					;FLAGSをスタックに保存。
   127 0000C299 CD 15                           	int	0x15				;BIOS INT 0x15
   128 0000C29B 66 9D                           	popfd					;FLAGSをスタックから復元。
   129 0000C29D E8 0050                         	call	a20_test			;ONになったか調べる。
   130 0000C2A0 75 4D                           	jnz	a20_done			;ONになっていたら終了。そうじゃなかったら続く。
   131 0000C2A2                                 a20_kbc:					;キーボードコントローラー（KBC）を使用したA20GATE有効化を試す。
   132 0000C2A2 E8 0073                         	call	empty_8042			;KBCのステータスレジスタを読んで、データポートが空になるまで待つ。
   133 0000C2A5 E8 0048                         	call	a20_test			;なんとなくもう一回、ONになったか調べる。
   134 0000C2A8 75 45                           	jnz	a20_done			;ONになっていたら終了。そうじゃなかったら続く。
   135 0000C2AA B0 D1                           	mov	al, 0xD1			;alに0xd1を代入。
   136 0000C2AC E6 64                           	out	0x64, al			;KBCのコマンド出力（ポート0x64）に0xd1を代入。直接代入できないので。
   137 0000C2AE E8 0067                         	call	empty_8042			;KBCのステータスレジスタを読んで、データポートが空になるまで待つ。
   138 0000C2B1 B0 DF                           	mov	al, 0xDF			;alに0xdfを代入。
   139 0000C2B3 E6 60                           	out	0x60, al			;KBCのデータ出力（ポート0x60）に0x60(A20GATE)
   140 0000C2B5 E8 0060                         	call	empty_8042			;KBCのステータスレジスタを読んで、データポートが空になるまで待つ。
   141 0000C2B8                                 a20_kbc_wait:					;とにかく待つ。
   142 0000C2B8 31 C9                           	xor	cx, cx				;loopの回数を指定。
   143 0000C2BA                                 a20_kbc_wait_loop:
   144 0000C2BA E8 0033                         	call	a20_test			;ONになったか調べる。
   145 0000C2BD 75 30                           	jnz	a20_done			;ONになっていたら終了。
   146 0000C2BF E2 F9                           	loop	a20_kbc_wait_loop		;loop(dec cxをして、ゼロになるまで何度もループ)。
   147 0000C2C1                                 a20_fast:					;最終手段　system control port（ポート0x92）。
   148 0000C2C1 E4 92                           	in	al, 0x92			;system control portをalに代入。
   149 0000C2C3 0C 02                           	or	al, 0x02			;alに0x02をor計算する。つまり、bit1を1にしている。
   150 0000C2C5                                 						;bit1=1=A20GATEをONにする。bit1=0=A20GATEをOFFにする。
   151 0000C2C5 24 FE                           	and	al, 0xFE			;さらに、alに0xfeをand計算する。
   152 0000C2C7 E6 92                           	out	0x92, al			;system control portにalを戻す。
   153 0000C2C9                                 a20_fast_wait:					;とにかく待つ。
   154 0000C2C9 31 C9                           	xor	cx, cx				;loopの回数を指定。
   155 0000C2CB                                 a20_fast_wait_loop:
   156 0000C2CB E8 0022                         	call	a20_test			;ONになったか調べる。
   157 0000C2CE 75 1F                           	jnz	a20_done			;ONになっていたら終了。
   158 0000C2D0 E2 F9                           	loop	a20_fast_wait_loop		;loop(dec cxをして、ゼロになるまで何度もループ)。
   159 0000C2D2 FE 0E C2EE                      	dec	byte [a20_tries]		;全体の繰り返し回数を一回減らす。
   160 0000C2D6 75 B7                           	jnz	a20_try_loop			;ゼロになるまであきらめず、最初から。。。
   161 0000C2D8                                 
   162 0000C2D8                                 a20_die:
   163 0000C2D8 66 8D 36 C718                   	lea	esi, [msg003]    ; 文字列があるところのアドレスをesiに代入する。
   164 0000C2DD B8 B800                         	mov	ax, 0xB800
   165 0000C2E0 8E C0                           	mov	es, ax		    ; esに0xB800を入れる。
   166 0000C2E2 66 BF 000000A0                  	mov	edi, 80*2	    ; 画面の二行目から始める。
   167 0000C2E8 E8 FF6F                         	call	printf
   168 0000C2EB E9 FF53                         	jmp	halthalt
   169 0000C2EE                                 
   170 0000C2EE                                 a20_tries:
   171 0000C2EE FF                              	db	A20_ENABLE_LOOPS
   172 0000C2EF                                 
   173 0000C2EF                                 ; ここまで来ると、A20がONになったとしていい。
   174 0000C2EF                                 a20_done:
   175 0000C2EF C3                              	ret
   176 0000C2F0                                 
   177 0000C2F0                                 a20_test:
   178 0000C2F0 51                              	push	cx
   179 0000C2F1 50                              	push	ax
   180 0000C2F2 31 C9                           	xor	cx, cx
   181 0000C2F4 8E E1                           	mov	fs, cx			    ; Low memory
   182 0000C2F6 49                              	dec	cx
   183 0000C2F7 8E E9                           	mov	gs, cx			    ; High memory area
   184 0000C2F9 B9 0020                         	mov	cx, A20_TEST_LOOPS
   185 0000C2FC 64 A1 0200                      	mov	ax, word [fs:A20_TEST_ADDR]
   186 0000C300 50                              	push	ax
   187 0000C301                                 a20_test_wait:
   188 0000C301 40                              	inc	ax
   189 0000C302 64 A3 0200                      	mov	word [fs:A20_TEST_ADDR], ax
   190 0000C306 E8 0030                         	call	delay				
   191 0000C309 65 3B 06 0210                   	cmp	ax, word [gs:A20_TEST_ADDR+0x10]
   192 0000C30E E2 F1                           	loop	a20_test_wait
   193 0000C310                                 
   194 0000C310 64 8F 06 0200                   	pop	word [fs:A20_TEST_ADDR]
   195 0000C315 58                              	pop	ax
   196 0000C316 59                              	pop	cx
   197 0000C317 C3                              	ret	
   198 0000C318                                 
   199 0000C318                                 empty_8042:
   200 0000C318 66 51                           	push	ecx
   201 0000C31A 66 B9 000186A0                  	mov	ecx, 100000
   202 0000C320                                 
   203 0000C320                                 empty_8042_loop:
   204 0000C320 66 49                           	dec	ecx
   205 0000C322 74 12                           	jz	empty_8042_end_loop
   206 0000C324                                 
   207 0000C324 E8 0012                         	call	delay
   208 0000C327                                 
   209 0000C327 E4 64                           	in	al, 0x64 		    ; 8042状態ポート 
   210 0000C329 A8 01                           	test	al, 1		; 出力バッファをテスト
   211 0000C32B 74 05                           	jz	no_output
   212 0000C32D                                 
   213 0000C32D E8 0009                         	call	delay
   214 0000C330                                 ;	in	al, 0x60			    ; 読む
   215 0000C330 EB EE                           	jmp	empty_8042_loop
   216 0000C332                                 
   217 0000C332                                 no_output:
   218 0000C332 A8 02                           	test	al, 2			    ; 入力バッファがいっぱいになったか 
   219 0000C334 75 EA                           	jnz	empty_8042_loop		    ; yes ? loopを回る
   220 0000C336                                 
   221 0000C336                                 empty_8042_end_loop:
   222 0000C336 66 59                           	pop	ecx
   223 0000C338 C3                              	ret
   224 0000C339                                 
   225 0000C339                                 delay:
   226 0000C339 E6 80                           	out	0x80, al
   227 0000C33B C3                              	ret
   228 0000C33C                                 
   229 0000C33C                                 getc:
   230 0000C33C B4 00                           	mov	ah,0x00
   231 0000C33E CD 16                           	int	0x16
   232 0000C340 C3                              	ret
   233 0000C341                                 
   234 0000C341                                 vbecheck:
   235 0000C341 66 8D 36 C7A3                   	lea	esi, [msg007]			;msg003のアドレスをesiに代入する。
   236 0000C346 B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
   237 0000C349 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
   238 0000C34B 66 BF 000001E0                  	mov	edi, 80*2*3		;画面の四行目から始める。
   239 0000C351 E8 FF06                         	call	printf				;printfを呼び出す。
   240 0000C354                                 
   241 0000C354 66 8D 36 C7D3                   	lea	esi, [msg008]			;msg003のアドレスをesiに代入する。
   242 0000C359 B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
   243 0000C35C 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
   244 0000C35E 66 BF 00000280                  	mov	edi, 80*2*4		;画面の四行目から始める。
   245 0000C364 E8 FEF3                         	call	printf				;printfを呼び出す。
   246 0000C367                                 
   247 0000C367 66 8D 36 C820                   	lea	esi, [msg009]			;msg003のアドレスをesiに代入する。
   248 0000C36C B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
   249 0000C36F 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
   250 0000C371 66 BF 00000320                  	mov	edi, 80*2*5		;画面の四行目から始める。
   251 0000C377 E8 FEE0                         	call	printf				;printfを呼び出す。
   252 0000C37A                                 
   253 0000C37A 66 8D 36 C86D                   	lea	esi, [msg010]			;msg003のアドレスをesiに代入する。
   254 0000C37F B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
   255 0000C382 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
   256 0000C384 66 BF 000003C0                  	mov	edi, 80*2*6		;画面の四行目から始める。
   257 0000C38A E8 FECD                         	call	printf				;printfを呼び出す。
   258 0000C38D                                 
   259 0000C38D 66 8D 36 C8BA                   	lea	esi, [msg011]			;msg003のアドレスをesiに代入する。
   260 0000C392 B8 B800                         	mov	ax, 0xB800			;アドレスの指定。テキストモードは、0xB800から始まる。
   261 0000C395 8E C0                           	mov	es, ax		    		;esに0xB800を入れる。esに直接代入はできないので。
   262 0000C397 66 BF 00000460                  	mov	edi, 80*2*7		;画面の四行目から始める。
   263 0000C39D E8 FEBA                         	call	printf				;printfを呼び出す。
   264 0000C3A0                                 
   265 0000C3A0 E8 FF99                         	call	getc
   266 0000C3A3                                 
   267 0000C3A3 80 FC 01                        	cmp	ah,0x01
   268 0000C3A6 0F 84 0081                      	je	vbe00
   269 0000C3AA                                 
   270 0000C3AA 80 FC 02                        	cmp	ah,0x02
   271 0000C3AD 0F 84 00BD                      	je	vbe01
   272 0000C3B1 80 FC 03                        	cmp	ah,0x03
   273 0000C3B4 0F 84 00BF                      	je	vbe02
   274 0000C3B8 80 FC 04                        	cmp	ah,0x04
   275 0000C3BB 0F 84 00C1                      	je	vbe03
   276 0000C3BF 80 FC 05                        	cmp	ah,0x05
   277 0000C3C2 0F 84 00C2                      	je	vbe04
   278 0000C3C6 80 FC 06                        	cmp	ah,0x06
   279 0000C3C9 0F 84 00C3                      	je	vbe05
   280 0000C3CD 80 FC 07                        	cmp	ah,0x07
   281 0000C3D0 0F 84 00C4                      	je	vbe06
   282 0000C3D4 80 FC 08                        	cmp	ah,0x08
   283 0000C3D7 0F 84 00C5                      	je	vbe07
   284 0000C3DB 80 FC 09                        	cmp	ah,0x09
   285 0000C3DE 0F 84 00C6                      	je	vbe08
   286 0000C3E2 80 FC 0A                        	cmp	ah,0x0a
   287 0000C3E5 0F 84 00C7                      	je	vbe09
   288 0000C3E9                                 
   289 0000C3E9 80 FC 1E                        	cmp	ah,0x1e
   290 0000C3EC 0F 84 00C8                      	je	vbe0a
   291 0000C3F0 80 FC 30                        	cmp	ah,0x30
   292 0000C3F3 0F 84 00C9                      	je	vbe0b
   293 0000C3F7 80 FC 2E                        	cmp	ah,0x2e
   294 0000C3FA 0F 84 00CA                      	je	vbe0c
   295 0000C3FE 80 FC 20                        	cmp	ah,0x20
   296 0000C401 0F 84 00CB                      	je	vbe0d
   297 0000C405 80 FC 12                        	cmp	ah,0x12
   298 0000C408 0F 84 00CC                      	je	vbe0e
   299 0000C40C 80 FC 21                        	cmp	ah,0x21
   300 0000C40F 0F 84 00CD                      	je	vbe0f
   301 0000C413 80 FC 22                        	cmp	ah,0x22
   302 0000C416 0F 84 00CE                      	je	vbe0g
   303 0000C41A 80 FC 23                        	cmp	ah,0x23
   304 0000C41D 0F 84 00CF                      	je	vbe0h
   305 0000C421 80 FC 17                        	cmp	ah,0x17
   306 0000C424 0F 84 00D0                      	je	vbe0i
   307 0000C428                                 
   308 0000C428 E9 FF16                         	jmp	vbecheck
   309 0000C42B                                 
   310 0000C42B                                 vbe00:
   311 0000C42B B0 13                           	mov	al,0x13
   312 0000C42D B4 00                           	mov	ah,0x00
   313 0000C42F CD 10                           	int	0x10
   314 0000C431 B8 00E0                         	mov	ax,0xe0
   315 0000C434 8E C0                           	mov	es,ax
   316 0000C436 BF 0000                         	mov	di,0
   317 0000C439 26 C7 45 12 0140                	mov	word[es:di+0x12],320
   318 0000C43F 26 C7 45 14 00C8                	mov	word[es:di+0x14],200
   319 0000C445 26 C6 45 19 08                  	mov	byte[es:di+0x19],8
   320 0000C44A 66 26 C7 45 28 000A0000         	mov	dword[es:di+0x28],0x000a0000
   321 0000C453 C6 06 0FF2 08                   	mov	byte[VMODE],8
   322 0000C458 C7 06 0FF4 0140                 	mov	word[SCRNX],320
   323 0000C45E C7 06 0FF6 00C8                 	mov	word[SCRNY],200
   324 0000C464 66 C7 06 0FF8 000A0000          	mov	dword[VRAM],0x000a0000
   325 0000C46D C3                              	ret
   326 0000C46E                                 
   327 0000C46E                                 vbe01:
   328 0000C46E C7 06 C8DC 010F                 	mov	word[videomode],0x010f
   329 0000C474 E9 0089                         	jmp	vbesub
   330 0000C477                                 vbe02:
   331 0000C477 C7 06 C8DC 0112                 	mov	word[videomode],0x0112
   332 0000C47D E9 0080                         	jmp	vbesub
   333 0000C480                                 vbe03:
   334 0000C480 C7 06 C8DC 0115                 	mov	word[videomode],0x0115
   335 0000C486 EB 78                           	jmp	vbesub
   336 0000C488                                 vbe04:
   337 0000C488 C7 06 C8DC 0118                 	mov	word[videomode],0x0118
   338 0000C48E EB 70                           	jmp	vbesub
   339 0000C490                                 vbe05:
   340 0000C490 C7 06 C8DC 011B                 	mov	word[videomode],0x011b
   341 0000C496 EB 68                           	jmp	vbesub
   342 0000C498                                 vbe06:
   343 0000C498 C7 06 C8DC 011F                 	mov	word[videomode],0x011f
   344 0000C49E EB 60                           	jmp	vbesub
   345 0000C4A0                                 vbe07:
   346 0000C4A0 C7 06 C8DC 010E                 	mov	word[videomode],0x010e
   347 0000C4A6 EB 58                           	jmp	vbesub
   348 0000C4A8                                 vbe08:
   349 0000C4A8 C7 06 C8DC 0111                 	mov	word[videomode],0x0111
   350 0000C4AE EB 50                           	jmp	vbesub
   351 0000C4B0                                 vbe09:
   352 0000C4B0 C7 06 C8DC 0114                 	mov	word[videomode],0x0114
   353 0000C4B6 EB 48                           	jmp	vbesub
   354 0000C4B8                                 vbe0a:
   355 0000C4B8 C7 06 C8DC 0117                 	mov	word[videomode],0x0117
   356 0000C4BE EB 40                           	jmp	vbesub
   357 0000C4C0                                 vbe0b:
   358 0000C4C0 C7 06 C8DC 011A                 	mov	word[videomode],0x011a
   359 0000C4C6 EB 38                           	jmp	vbesub
   360 0000C4C8                                 vbe0c:
   361 0000C4C8 C7 06 C8DC 011E                 	mov	word[videomode],0x011e
   362 0000C4CE EB 30                           	jmp	vbesub
   363 0000C4D0                                 vbe0d:
   364 0000C4D0 C7 06 C8DC 0100                 	mov	word[videomode],0x0100
   365 0000C4D6 EB 28                           	jmp	vbesub
   366 0000C4D8                                 vbe0e:
   367 0000C4D8 C7 06 C8DC 0101                 	mov	word[videomode],0x0101
   368 0000C4DE EB 20                           	jmp	vbesub
   369 0000C4E0                                 vbe0f:
   370 0000C4E0 C7 06 C8DC 0103                 	mov	word[videomode],0x0103
   371 0000C4E6 EB 18                           	jmp	vbesub
   372 0000C4E8                                 vbe0g:
   373 0000C4E8 C7 06 C8DC 0105                 	mov	word[videomode],0x0105
   374 0000C4EE EB 10                           	jmp	vbesub
   375 0000C4F0                                 vbe0h:
   376 0000C4F0 C7 06 C8DC 0107                 	mov	word[videomode],0x0107
   377 0000C4F6 EB 08                           	jmp	vbesub
   378 0000C4F8                                 vbe0i:
   379 0000C4F8 C7 06 C8DC 011C                 	mov	word[videomode],0x011c
   380 0000C4FE EB 00                           	jmp	vbesub
   381 0000C500                                 
   382 0000C500                                 vbesub:
   383 0000C500 B8 00E0                         	mov	ax,0xe0
   384 0000C503 8E C0                           	mov	es,ax
   385 0000C505 BF 0000                         	mov	di,0
   386 0000C508 8B 0E C8DC                      	mov	cx,[videomode]
   387 0000C50C B8 4F01                         	mov	ax,0x4f01
   388 0000C50F CD 10                           	int	0x10
   389 0000C511                                 
   390 0000C511 B8 9000                         	mov	ax,0x9000
   391 0000C514 8E C0                           	mov	es,ax
   392 0000C516 BF 0000                         	mov	di,0
   393 0000C519 B8 4F00                         	mov	ax,0x4f00
   394 0000C51C CD 10                           	int	0x10
   395 0000C51E 3D 004F                         	cmp	ax,0x004f
   396 0000C521 75 41                           	jne	scrn320
   397 0000C523 26 8B 45 04                     	mov	ax,[es:di+4]
   398 0000C527 3D 0200                         	cmp	ax,0x0200
   399 0000C52A 72 38                           	jb	scrn320
   400 0000C52C 8B 0E C8DC                      	mov	cx,[videomode]
   401 0000C530 B8 4F01                         	mov	ax,0x4f01
   402 0000C533 CD 10                           	int	0x10
   403 0000C535 3D 004F                         	cmp	ax,0x004f
   404 0000C538 75 2A                           	jne	scrn320
   405 0000C53A                                 
   406 0000C53A 8B 1E C8DC                      	mov	bx,[videomode]
   407 0000C53E 81 C3 4000                      	add	bx,0x4000
   408 0000C542 B8 4F02                         	mov	ax,0x4f02
   409 0000C545 CD 10                           	int	0x10
   410 0000C547 C6 06 0FF2 10                   	mov	byte[VMODE],16
   411 0000C54C 26 8B 45 12                     	mov	ax,[es:di+0x12]
   412 0000C550 A3 0FF4                         	mov	[SCRNX],ax
   413 0000C553 26 8B 45 14                     	mov	ax,[es:di+0x14]
   414 0000C557 A3 0FF6                         	mov	[SCRNY],ax
   415 0000C55A 66 26 8B 45 28                  	mov	eax,[es:di+0x28]
   416 0000C55F 66 A3 0FF8                      	mov	[VRAM],eax
   417 0000C563 C3                              	ret
   418 0000C564                                 
   419 0000C564                                 scrn320:
   420 0000C564                                 
   421 0000C564 66 8D 36 C728                   	lea	esi, [msg004]    ; 文字列があるところのアドレスをesiに代入する。
   422 0000C569 B8 B800                         	mov	ax, 0xB800
   423 0000C56C 8E C0                           	mov	es, ax		    ; esに0xB800を入れる。
   424 0000C56E 66 BF 00000280                  	mov	edi, 80*2*2*2	    ; 画面の二行目から始める。
   425 0000C574 E8 FCE3                         	call	printf
   426 0000C577 E9 FCC7                         	jmp	halthalt
   427 0000C57A                                 
   428 0000C57A B0 13                           	mov	al,0x13
   429 0000C57C B4 00                           	mov	ah,0x00
   430 0000C57E CD 10                           	int	0x10
   431 0000C580                                 
   432 0000C580 B8 00E0                         	mov	ax,0xe0
   433 0000C583 8E C0                           	mov	es,ax
   434 0000C585 BF 0000                         	mov	di,0
   435 0000C588 26 C7 45 12 0140                	mov	word[es:di+0x12],320
   436 0000C58E 26 C7 45 14 00C8                	mov	word[es:di+0x14],200
   437 0000C594 26 C6 45 19 08                  	mov	byte[es:di+0x19],8
   438 0000C599 66 26 C7 45 28 000A0000         	mov	dword[es:di+0x28],0x000a0000
   439 0000C5A2                                 
   440 0000C5A2 C6 06 0FF2 08                   	mov	byte[VMODE],8
   441 0000C5A7 C7 06 0FF4 0140                 	mov	word[SCRNX],320
   442 0000C5AD C7 06 0FF6 00C8                 	mov	word[SCRNY],200
   443 0000C5B3 66 C7 06 0FF8 000A0000          	mov	dword[VRAM],0x000a0000
   444 0000C5BC C3                              	ret
   445 0000C5BD                                 
   446 0000C5BD                                 keyled:
   447 0000C5BD B4 02                           	mov	ah,0x02
   448 0000C5BF CD 16                           	int	0x16
   449 0000C5C1 A2 0FF1                         	mov	[LEDS],al
   450 0000C5C4 C3                              	ret
   451 0000C5C5                                 
   452 0000C5C5                                 pmode:
   453 0000C5C5 B0 FF                           	mov	al,0xff
   454 0000C5C7 E6 21                           	out	0x21,al
   455 0000C5C9 90                              	nop
   456 0000C5CA E6 A1                           	out	0xa1,al
   457 0000C5CC FA                              	cli
   458 0000C5CD                                 
   459 0000C5CD 0F 01 16 C8FA                   	lgdt	[GDTR0]
   460 0000C5D2 0F 20 C0                        	mov	eax,cr0
   461 0000C5D5 66 25 7FFFFFFF                  	and	eax,0x7fffffff
   462 0000C5DB 66 83 C8 01                     	or	eax,0x00000001
   463 0000C5DF 0F 22 C0                        	mov	cr0,eax
   464 0000C5E2 EB 00                           	jmp	pipelineflush
   465 0000C5E4                                 pipelineflush:
   466 0000C5E4 B8 0008                         	mov	ax,1*8
   467 0000C5E7 8E D8                           	mov	ds,ax
   468 0000C5E9 8E C0                           	mov	es,ax
   469 0000C5EB 8E E0                           	mov	fs,ax
   470 0000C5ED 8E E8                           	mov	gs,ax
   471 0000C5EF 8E D0                           	mov	ss,ax
   472 0000C5F1 66 BE 0000C900                  	mov	esi,bootpack	;転送元
   473 0000C5F7 66 BF 00280000                  	mov	edi,BOTPAK	;転送先
   474 0000C5FD 66 B9 00020000                  	mov	ecx,512*1024/4
   475 0000C603 E8 006E                         	call	memcpy
   476 0000C606 66 BE 00007C00                  	mov	esi,0x7c00
   477 0000C60C 66 BF 00100000                  	mov	edi,DSKCAC
   478 0000C612 66 B9 00000080                  	mov	ecx,512/4
   479 0000C618 E8 0059                         	call	memcpy
   480 0000C61B 66 BE 00008200                  	mov	esi,DSKCAC0+512
   481 0000C621 66 BF 00100200                  	mov	edi,DSKCAC+512
   482 0000C627 66 B9 00000000                  	mov	ecx,0
   483 0000C62D 8A 0E 0FF0                      	mov	cl,byte[CYLS]
   484 0000C631 66 69 C9 00001200               	imul	ecx,512*18*2/4
   485 0000C638 66 81 E9 00000080               	sub	ecx,512/4
   486 0000C63F E8 0032                         	call	memcpy
   487 0000C642                                 	
   488 0000C642 66 BB 00280000                  	mov	ebx,BOTPAK
   489 0000C648 67 66 8B 4B 10                  	mov	ecx,[ebx+16]
   490 0000C64D 66 83 C1 03                     	add	ecx,3
   491 0000C651 66 C1 E9 02                     	shr	ecx,2
   492 0000C655 74 10                           	jz	skip
   493 0000C657 67 66 8B 73 14                  	mov	esi,[ebx+20]
   494 0000C65C 66 01 DE                        	add	esi,ebx
   495 0000C65F 67 66 8B 7B 0C                  	mov	edi,[ebx+12]
   496 0000C664 E8 000D                         	call	memcpy
   497 0000C667                                 skip:
   498 0000C667 67 66 8B 63 0C                  	mov	esp,[ebx+12]
   499 0000C66C 66 EA 0000001B 0010             	jmp	dword 2*8:0x0000001b
   500 0000C674                                 
   501 0000C674                                 
   502 0000C674                                 memcpy:
   503 0000C674 67 66 8B 06                     	mov	eax,[esi]
   504 0000C678 66 83 C6 04                     	add	esi,4
   505 0000C67C 67 66 89 07                     	mov	[edi],eax
   506 0000C680 66 83 C7 04                     	add	edi,4
   507 0000C684 66 83 E9 01                     	sub	ecx,1
   508 0000C688 75 EA                           	jnz	memcpy			; 引き算した結果が0でなければmemcpyへ
   509 0000C68A C3                              	ret
   510 0000C68B                                 
   511 0000C68B                                 entkeywait:
   512 0000C68B B4 00                           	mov	ah,0
   513 0000C68D CD 16                           	int	0x16
   514 0000C68F 80 FC 1C                        	cmp	ah,0x1c
   515 0000C692 75 F7                           	jne	entkeywait
   516 0000C694 C3                              	ret
   517 0000C695                                 
   518 0000C695                                 shutdown:
   519 0000C695 B8 5300                         	mov	ax,0x5300
   520 0000C698 BB 0000                         	mov	bx,0
   521 0000C69B CD 15                           	int	0x15
   522 0000C69D 72 3B                           	jc	thend
   523 0000C69F B8 5301                         	mov	ax,0x5301
   524 0000C6A2 BB 0000                         	mov	bx,0
   525 0000C6A5 CD 15                           	int	0x15
   526 0000C6A7 B8 530E                         	mov	ax,0x530e
   527 0000C6AA BB 0000                         	mov	bx,0
   528 0000C6AD B9 0101                         	mov	cx,0x0101
   529 0000C6B0 CD 15                           	int	0x15
   530 0000C6B2 72 26                           	jc	thend
   531 0000C6B4 B8 530F                         	mov	ax,0x530f
   532 0000C6B7 BB 0001                         	mov	bx,0x0001
   533 0000C6BA B9 0001                         	mov	cx,0x0001
   534 0000C6BD CD 15                           	int	0x15
   535 0000C6BF 72 19                           	jc	thend
   536 0000C6C1 B8 5308                         	mov	ax,0x5308
   537 0000C6C4 BB 0001                         	mov	bx,0x0001
   538 0000C6C7 B9 0001                         	mov	cx,0x0001
   539 0000C6CA CD 15                           	int	0x15
   540 0000C6CC 72 0C                           	jc	thend
   541 0000C6CE B8 5307                         	mov	ax,0x5307
   542 0000C6D1 BB 0001                         	mov	bx,0x0001
   543 0000C6D4 B9 0003                         	mov	cx,0x0003
   544 0000C6D7 CD 15                           	int	0x15
   545 0000C6D9 F4                              	hlt
   546 0000C6DA                                 
   547 0000C6DA                                 thend:
   548 0000C6DA 66 8D 36 C775                   	lea	esi, [msg006]    ; 文字列があるところのアドレスをesiに代入する。
   549 0000C6DF B8 B800                         	mov	ax, 0xB800
   550 0000C6E2 8E C0                           	mov	es, ax		    ; esに0xB800を入れる。
   551 0000C6E4 66 BF 00000500                  	mov	edi, 80*2*2*2*2	    ; 画面の二行目から始める。
   552 0000C6EA E8 FB6D                         	call	printf
   553 0000C6ED                                 thend2:
   554 0000C6ED F4                              	hlt
   555 0000C6EE EB FD                           	jmp	thend2	
   556 0000C6F0                                 
   557 0000C6F0                                 ;データ
   558 0000C6F0                                 
   559 0000C6F0 57 65 6C 63 6F 6D 65 20 74 6F   msg001:	db	"Welcome to chnos project .",0
       0000C6FA 20 63 68 6E 6F 73 20 70 72 6F 
       0000C704 6A 65 63 74 20 2E 00 
   560 0000C70B 41 32 30 47 41 54 45 20 6F 6E   msg002:	db	"A20GATE on .",0
       0000C715 20 2E 00 
   561 0000C718 41 32 30 47 41 54 45 20 66 69   msg003:	db	"A20GATE filed .",0
       0000C722 6C 65 64 20 2E 00 
   562 0000C728 56 69 64 65 6F 20 6D 6F 64 65   msg004:	db	"Video mode is not supported or invalid.",0
       0000C732 20 69 73 20 6E 6F 74 20 73 75 
       0000C73C 70 70 6F 72 74 65 64 20 6F 72 
       0000C746 20 69 6E 76 61 6C 69 64 2E 00 
   563 0000C750 50 72 65 73 73 20 74 68 65 20   msg005:	db	"Press the Enter key to shut down ...",0
       0000C75A 45 6E 74 65 72 20 6B 65 79 20 
       0000C764 74 6F 20 73 68 75 74 20 64 6F 
       0000C76E 77 6E 20 2E 2E 2E 00 
   564 0000C775 53 6F 72 72 79 20 2E 20 53 68   msg006:	db	"Sorry . Shutdown filed . Press power button .",0
       0000C77F 75 74 64 6F 77 6E 20 66 69 6C 
       0000C789 65 64 20 2E 20 50 72 65 73 73 
       0000C793 20 70 6F 77 65 72 20 62 75 74 
       0000C79D 74 6F 6E 20 2E 00 
   565 0000C7A3 56 69 64 65 6F 20 4D 6F 64 65   msg007:	db	"Video Mode List. Please select the mode number.",0
       0000C7AD 20 4C 69 73 74 2E 20 50 6C 65 
       0000C7B7 61 73 65 20 73 65 6C 65 63 74 
       0000C7C1 20 74 68 65 20 6D 6F 64 65 20 
       0000C7CB 6E 75 6D 62 65 72 2E 00 
   566 0000C7D3 33 32 62 69 74 2D 2D 31 3A 33   msg008:	db	"32bit--1:320x200--2:640x480--3:800x600--4:1024x768--5:1280x1024--6:1600x1200",0
       0000C7DD 32 30 78 32 30 30 2D 2D 32 3A 
       0000C7E7 36 34 30 78 34 38 30 2D 2D 33 
       0000C7F1 3A 38 30 30 78 36 30 30 2D 2D 
       0000C7FB 34 3A 31 30 32 34 78 37 36 38 
       0000C805 2D 2D 35 3A 31 32 38 30 78 31 
       0000C80F 30 32 34 2D 2D 36 3A 31 36 30 
       0000C819 30 78 31 32 30 30 00 
   567 0000C820 31 36 62 69 74 2D 2D 37 3A 33   msg009:	db	"16bit--7:320x200--8:640x480--9:800x600--a:1024x768--b:1280x1024--c:1600x1200",0
       0000C82A 32 30 78 32 30 30 2D 2D 38 3A 
       0000C834 36 34 30 78 34 38 30 2D 2D 39 
       0000C83E 3A 38 30 30 78 36 30 30 2D 2D 
       0000C848 61 3A 31 30 32 34 78 37 36 38 
       0000C852 2D 2D 62 3A 31 32 38 30 78 31 
       0000C85C 30 32 34 2D 2D 63 3A 31 36 30 
       0000C866 30 78 31 32 30 30 00 
   568 0000C86D 20 38 62 69 74 2D 2D 64 3A 36   msg010:	db	" 8bit--d:640x400--e:640x480--f:800x600--g:1024x768--h:1280x1024--i:1600x1200",0
       0000C877 34 30 78 34 30 30 2D 2D 65 3A 
       0000C881 36 34 30 78 34 38 30 2D 2D 66 
       0000C88B 3A 38 30 30 78 36 30 30 2D 2D 
       0000C895 67 3A 31 30 32 34 78 37 36 38 
       0000C89F 2D 2D 68 3A 31 32 38 30 78 31 
       0000C8A9 30 32 34 2D 2D 69 3A 31 36 30 
       0000C8B3 30 78 31 32 30 30 00 
   569 0000C8BA 50 72 65 73 73 20 45 53 43 20   msg011:	db	"Press ESC to start in VGA mode.",0
       0000C8C4 74 6F 20 73 74 61 72 74 20 69 
       0000C8CE 6E 20 56 47 41 20 6D 6F 64 65 
       0000C8D8 2E 00 
   570 0000C8DA 2E 00                           backcc:	db	".",0
   571 0000C8DC                                 
   572 0000C8DC 0000                            videomode:	dw 0
   573 0000C8DE                                 
   574 0000C8DE 00 00                           		alignb	16
   575 0000C8E0                                 GDT0:
   576 0000C8E0 00 00 00 00 00 00 00 00         		resb	8				; ヌルセレクタ
   577 0000C8E8 FFFF 0000 9200 00CF             		dw		0xffff,0x0000,0x9200,0x00cf	; 読み書き可能セグメント32bit
   578 0000C8F0 FFFF 0000 9A28 0047             		dw		0xffff,0x0000,0x9a28,0x0047	; 実行可能セグメント32bit（bootpack用）
   579 0000C8F8                                 
   580 0000C8F8 0000                            		dw		0
   581 0000C8FA                                 GDTR0:
   582 0000C8FA 0017                            		dw		8*3-1
   583 0000C8FC 0000C8E0                        		dd		GDT0
   584 0000C900                                 
   585 0000C900                                 		alignb	16
   586 0000C900                                 bootpack:
   587 0000C900                                 
   588 0000C900                                 
   589 0000C900                                 
